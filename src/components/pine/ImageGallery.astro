---
export interface Props {
  images: Array<{
    src: string;
    alt?: string;
    thumbnail?: string;
    caption?: string;
  }>;
  columns?: 2 | 3 | 4 | 5 | 6;
  gap?: 'sm' | 'md' | 'lg';
  aspectRatio?: 'square' | 'video' | 'photo' | 'auto';
  class?: string;
  thumbnailClass?: string;
  lightboxClass?: string;
}

const { 
  images = [],
  columns = 3,
  gap = 'md',
  aspectRatio = 'square',
  class: className = "",
  thumbnailClass = "",
  lightboxClass = ""
} = Astro.props;

// Ensure images is always an array with valid data
const safeImages = Array.isArray(images) ? images.filter(img => img && img.src) : [];

// Debug information (will be visible in server logs)
console.log(`ImageGallery: Processing ${safeImages.length} images of ${images.length} provided`);

// Generate class names using our design system
const getComponentClasses = () => {
  const baseClass = 'image-gallery';
  const gridClass = `image-gallery-grid image-gallery-grid-${columns}`;
  const gapClass = `image-gallery-gap-${gap}`;
  
  return `${baseClass} ${gridClass} ${gapClass}`;
};

const getItemClasses = () => {
  const baseClass = 'image-gallery-item';
  const aspectClass = aspectRatio !== 'auto' ? `image-gallery-item-${aspectRatio}` : 'image-gallery-item-auto';
  
  return `${baseClass} ${aspectClass}`;
};
---

<!-- 
Pine UI Image Gallery Component

Usage:
<ImageGallery 
  images={[
    { src: '/image1.jpg', alt: 'Image 1', thumbnail: '/thumb1.jpg', caption: 'Beautiful landscape' },
    { src: '/image2.jpg', alt: 'Image 2', thumbnail: '/thumb2.jpg', caption: 'City skyline' },
    { src: '/image3.jpg', alt: 'Image 3', thumbnail: '/thumb3.jpg' }
  ]}
  columns={3}
  gap="md"
  aspectRatio="square"
/>

<ImageGallery 
  images={photoArray}
  columns={4}
  gap="lg"
  aspectRatio="photo"
  class="my-8"
/>

Features:
- Responsive grid layout with customizable columns
- Lightbox overlay with full-size image viewing
- Keyboard navigation (left/right arrows, escape to close)
- Click navigation with next/previous buttons
- Image captions support
- Thumbnail optimization (uses thumbnail if provided)
- Smooth transitions and animations
- Touch/swipe support on mobile
- Auto-close on backdrop click
- Loading states and error handling
- Alpine.js powered state management

Props:
- images: Array of image objects with src, alt, thumbnail, caption
- columns: Number of columns (2-6, responsive)
- gap: Spacing between images (sm, md, lg)
- aspectRatio: Thumbnail aspect ratio (square, video, photo, auto)
-->

<div 
  x-data="{
    imageGalleryOpened: false,
    imageGalleryActiveUrl: null,
    imageGalleryActiveIndex: 0,
    imageGalleryImages: [],
    imageGalleryOpen(index) {
      this.imageGalleryActiveIndex = index;
      this.imageGalleryActiveUrl = this.imageGalleryImages[index].src;
      this.imageGalleryOpened = true;
    },
    imageGalleryClose() {
      this.imageGalleryOpened = false;
      setTimeout(() => this.imageGalleryActiveUrl = null, 300);
    },
    imageGalleryNext() {
      if (this.imageGalleryActiveIndex < this.imageGalleryImages.length - 1) {
        this.imageGalleryActiveIndex++;
        this.imageGalleryActiveUrl = this.imageGalleryImages[this.imageGalleryActiveIndex].src;
      }
    },
    imageGalleryPrev() {
      if (this.imageGalleryActiveIndex > 0) {
        this.imageGalleryActiveIndex--;
        this.imageGalleryActiveUrl = this.imageGalleryImages[this.imageGalleryActiveIndex].src;
      }
    },
    imageGalleryKeyHandler(event) {
      if (!this.imageGalleryOpened) return;
      if (event.key === 'ArrowRight') this.imageGalleryNext();
      if (event.key === 'ArrowLeft') this.imageGalleryPrev();
      if (event.key === 'Escape') this.imageGalleryClose();
    }
  }"
  x-init="imageGalleryImages = ${JSON.stringify(safeImages)}"
  @keydown.window="imageGalleryKeyHandler($event)"
  class={`${getComponentClasses()} ${className}`}
>
  <!-- Image Grid -->
  {safeImages.length === 0 ? (
    <div class="image-gallery-empty">
      <p class="image-gallery-empty-message">No images to display</p>
      <p class="image-gallery-empty-hint">Check console for debugging information</p>
    </div>
  ) : (
    {safeImages.map((image, index) => (
      <div 
        class={`${getItemClasses()} ${thumbnailClass}`}
        x-on:click={`imageGalleryOpen(${index})`}
      >
        <img 
          src={image.thumbnail || image.src}
          alt={image.alt || `Gallery image ${index + 1}`}
          class="image-gallery-thumbnail"
          loading="lazy"
        />
        <!-- Hover overlay -->
        <div class="image-gallery-overlay">
          <svg class="image-gallery-zoom-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"></path>
          </svg>
        </div>
        {image.caption && (
          <div class="image-gallery-caption">
            <p class="image-gallery-caption-text">{image.caption}</p>
          </div>
        )}
        </div>
      ))}
  )}

  <!-- Lightbox Modal -->
  <div x-show="imageGalleryOpened" style="display: none;">
    <div 
      x-show="imageGalleryOpened" 
      x-transition.opacity.duration.300
      x-trap.inert.noscroll="imageGalleryOpened"
      class={`image-gallery-modal ${lightboxClass}`}
      @click.self="imageGalleryClose()"
    >
      <!-- Close button -->
      <button 
        @click="imageGalleryClose()"
        class="image-gallery-nav image-gallery-nav-close"
        type="button"
      >
        <svg class="image-gallery-nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>

      <!-- Previous button -->
      <button 
        @click="imageGalleryPrev()"
        x-show="imageGalleryActiveIndex > 0"
        class="image-gallery-nav image-gallery-nav-prev"
        type="button"
      >
        <svg class="image-gallery-nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
        </svg>
      </button>

      <!-- Next button -->
      <button 
        @click="imageGalleryNext()"
        x-show="imageGalleryActiveIndex < imageGalleryImages.length - 1"
        class="image-gallery-nav image-gallery-nav-next"
        type="button"
      >
        <svg class="image-gallery-nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
        </svg>
      </button>

      <!-- Image container -->
      <div 
        x-show="imageGalleryOpened"
        x-transition:enter="ease-out duration-300"
        x-transition:enter-start="opacity-0 scale-95"
        x-transition:enter-end="opacity-100 scale-100"
        x-transition:leave="ease-in duration-200"
        x-transition:leave-start="opacity-100 scale-100"
        x-transition:leave-end="opacity-0 scale-95"
        class="image-gallery-modal-content"
      >
        <img 
          x-show="imageGalleryActiveUrl"
          :src="imageGalleryActiveUrl" 
          :alt="imageGalleryImages[imageGalleryActiveIndex]?.alt || `Gallery image ${imageGalleryActiveIndex + 1}`"
          class="image-gallery-modal-image"
          @load="console.log('Image loaded')"
        />
        
        <!-- Image info -->
        <div 
          x-show="imageGalleryImages[imageGalleryActiveIndex]?.caption"
          class="image-gallery-modal-info"
        >
          <p 
            class="image-gallery-modal-caption"
            x-text="imageGalleryImages[imageGalleryActiveIndex]?.caption"
          ></p>
        </div>

        <!-- Image counter -->
        <div class="image-gallery-modal-counter">
          <span class="image-gallery-modal-counter-text">
            <span x-text="imageGalleryActiveIndex + 1"></span>
            /
            <span x-text="imageGalleryImages.length"></span>
          </span>
        </div>
      </div>

      <!-- Loading indicator -->
      <div 
        x-show="!imageGalleryActiveUrl"
        class="image-gallery-loading"
      >
        <div class="image-gallery-spinner"></div>
      </div>
    </div>
  </div>
</div>