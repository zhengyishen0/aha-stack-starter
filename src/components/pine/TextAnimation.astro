---
export interface Props {
  text: string;
  animation?: 'fade' | 'scale' | 'slide' | 'bounce';
  stagger?: number;
  duration?: number;
  autoStart?: boolean;
  class?: string;
}

const { 
  text,
  animation = 'fade',
  stagger = 0.1,
  duration = 0.5,
  autoStart = true,
  class: className = ""
} = Astro.props;

// Generate class names using our design system
const getTextAnimationClasses = () => {
  const baseClass = 'text-animation';
  const animationClass = `text-animation-${animation}`;
  
  return `${baseClass} ${animationClass}`;
};
---

<!-- 
Pine UI Text Animation Component

Usage:
<TextAnimation 
  text="Hello World!" 
  animation="scale" 
  stagger={0.1}
  duration={0.5}
  autoStart={true}
/>

Features:
- Character-by-character animation
- Multiple animation types
- Configurable timing
- GSAP powered animations
- Auto-loading GSAP from CDN
-->

<div 
  x-data={`{
    startingAnimation: false,
    endingAnimation: false,
    addCNDScript: false,
    text: ${JSON.stringify(text)},
    animationType: ${JSON.stringify(animation)},
    stagger: ${stagger},
    duration: ${duration},
    autoStart: ${autoStart}
  }`}
  x-init="
    if (autoStart) {
      $nextTick(() => {
        startAnimation();
      });
    }
    
    // Listen for custom event to trigger animation manually
    $el.addEventListener('startAnimation', () => {
      startAnimation();
    });
    
    function startAnimation() {
      if (!window.gsap) {
        addCNDScript = true;
        let script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js';
        script.onload = function() {
          runAnimation();
        };
        document.head.appendChild(script);
      } else {
        runAnimation();
      }
    }
    
    function runAnimation() {
      const chars = $refs.textContainer.querySelectorAll('.text-animation-char');
      const tl = gsap.timeline();
      
      // Reset animation state first
      $el.classList.remove('text-animation-animate');
      
      // Set initial state based on animation type
      gsap.set(chars, {
        opacity: animationType === 'fade' ? 0 : 1,
        scale: animationType === 'scale' ? 0 : 1,
        x: animationType === 'slide' ? -20 : 0,
        y: animationType === 'bounce' ? -20 : 0
      });
      
      // Add animate class to trigger design system transitions
      $el.classList.add('text-animation-animate');
      
      // Animate in with GSAP for staggered timing
      tl.to(chars, {
        opacity: 1,
        scale: 1,
        x: 0,
        y: 0,
        duration: duration,
        stagger: stagger,
        ease: animationType === 'bounce' ? 'bounce.out' : 'power2.out'
      });
    }
  "
  class={`${getTextAnimationClasses()} ${className}`}
>
  <div x-ref="textContainer" class="text-animation-container">
    <template x-for="(char, index) in text.split('')" :key="index">
      <span 
        class="text-animation-char"
        x-text="char === ' ' ? '\\u00A0' : char"
      ></span>
    </template>
  </div>
</div>