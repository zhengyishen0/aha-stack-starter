---
import Layout from '../layouts/Layout.astro';
import {
    Badge,
    Button,
    Card,
    Column,
    Empty,
    Error,
    List,
    ListItem,
    Loading,
    Page,
    Row,
    Switch,
    Text,
} from '../components/ui/core';
import { Checkbox, TextInput } from '../components/ui/forms';
import { Navbar } from '../components/ui/navigation';

// Page-specific styles
import './todo.css';

const title = 'Todo App with Supabase';

const pageData = `{ 
            auth: $store.auth,
            todo: $store.todo,
            async init() {
                await this.auth.init();
                await this.todo.loadTodos();
            },
            async signInAnonymously() {
                await this.auth.signInAnonymously();
                await this.todo.loadTodos();
            },
            async signOut() {
                await this.auth.signOut();
                this.todo.cleanup();
            }
        }`;
---

<Layout title={title}>
    <Page
        maxWidth="full"
        class="page-background"
        x-data={pageData}
        x-init="init()"
    >
        <!-- Navigation Bar -->
        <Navbar variant="elevated" maxWidth="full">
            <Button slot="left" href="../" variant="solid" size="sm"
                >Back to Home</Button
            >

            <Text slot="center" as="h5">Supabase Todo App</Text>
        </Navbar>

        <!-- Main Content -->
        <Switch condition="auth.isAuthenticated" class="page-container">
            <!-- Not authenticated state -->
            <Card slot="false" context="spacious" class="auth-card">
                <Text as="p">Click to start using the app</Text>
                <Button
                    @click="signInAnonymously()"
                    :disabled="auth.loading || todo.loading"
                    size="md"
                    color="primary"
                    x-text="auth.loading ? 'Signing in...' : 'Sign In Anonymously'"
                />
            </Card>

            <!-- Authenticated state - Todo App -->
            <Row slot="true" class="two-column-grid">
                <!-- Left Column: My Todos -->
                <Card class="fullheight-card">
                    <Text as="h2" slot="header" class="column-title"
                        >My Todos</Text
                    >
                    <Column slot="body">
                        <!-- Filter Buttons and Auth Info -->
                        <Row justify="between" wrap>
                            <!-- Status Filter Buttons (Left) -->
                            <Row gap="tight">
                                <Button
                                    @click="todo.setUserFilter('all')"
                                    :variant="todo.userFilter === 'all' ? 'solid' : 'outline'"
                                    color="primary"
                                    size="xs"
                                >
                                    All
                                </Button>
                                <Button
                                    @click="todo.setUserFilter('active')"
                                    :variant="todo.userFilter === 'active' ? 'solid' : 'outline'"
                                    color="primary"
                                    size="xs"
                                >
                                    Active
                                </Button>
                                <Button
                                    @click="todo.setUserFilter('completed')"
                                    :variant="todo.userFilter === 'completed' ? 'solid' : 'outline'"
                                    color="primary"
                                    size="xs"
                                >
                                    Completed
                                </Button>
                            </Row>

                            <!-- Auth Info (Right) -->
                            <Row gap="loose">
                                <Text
                                    >Signed in as: <strong
                                        x-text="auth.userDisplayId"
                                        class="user-display-name"
                                    ></strong></Text
                                >
                                <Button
                                    @click="signOut()"
                                    size="xs"
                                    variant="solid"
                                    color="primary">Sign Out</Button
                                >
                            </Row>
                        </Row>

                        <!-- Error Message -->
                        <Error x-show="todo.error" x-text="todo.error" />

                        <!-- Loading State -->
                        <Loading
                            x-show="todo.loading && todo.filteredUserTodos.length === 0"
                        >
                            Loading your todos...
                        </Loading>

                        <!-- User Todo List - Flex 1 to take remaining space -->
                        <List
                            spacing="default"
                            x-for="item in todo.filteredUserTodos"
                            x-key="item.id"
                        >
                            <ListItem align="center">
                                <Checkbox
                                    slot="left"
                                    :checked="item.is_complete"
                                    @change="todo.toggleTodo(item.id, $event.target.checked)"
                                />
                                <Text
                                    :state="item.is_complete ? 'completed' : 'active'"
                                    x-text="item.task"
                                />
                                <Button
                                    slot="right"
                                    @click="todo.deleteTodo(item.id)"
                                    size="xs"
                                    variant="solid"
                                    color="danger"
                                >
                                    Delete
                                </Button>
                            </ListItem>
                        </List>

                        <!-- Empty State -->
                        <Empty
                            x-show="todo.filteredUserTodos.length === 0 && !todo.loading"
                        >
                            <Text as="p" x-show="todo.userFilter === 'all'"
                                >No todos yet. Add one below!</Text
                            >
                            <Text as="p" x-show="todo.userFilter === 'active'"
                                >No active todos.</Text
                            >
                            <Text
                                as="p"
                                x-show="todo.userFilter === 'completed'"
                                >No completed todos.</Text
                            >
                        </Empty>
                    </Column>

                    <!-- Stats -->
                    <div
                        slot="footer"
                        x-show="todo.userTodos.length > 0"
                        class="centered-stats"
                    >
                        <Text as="span" x-text="todo.userActiveCount" /> active,
                        <Text as="span" x-text="todo.userCompletedCount" /> completed
                    </div>

                    <!-- Add Todo Form -->
                    <form
                        slot="footer"
                        @submit.prevent="todo.addTodo($refs.todoInput.value); $refs.todoInput.value = ''"
                        class="bottom-aligned-form"
                    >
                        <Row gap="default">
                            <TextInput
                                x-ref="todoInput"
                                type="text"
                                placeholder="Add a new todo..."
                                required
                                class="flexible-input"
                            />
                            <Button
                                type="submit"
                                :disabled="todo.loading"
                                size="sm"
                                color="primary"
                                x-text="todo.loading ? '...' : 'Add'"
                            />
                        </Row>
                    </form>
                </Card>

                <!-- Right Column: All Todos -->
                <Card class="fullheight-card">
                    <Text as="h2" slot="header" class="column-title"
                        >Realtime Todos</Text
                    >
                    <Column slot="body">
                        <!-- Filter Buttons and User Count -->
                        <Row justify="between" wrap>
                            <!-- Status Filter Buttons (Left) -->
                            <Row gap="tight">
                                <Button
                                    @click="todo.setAllFilter('all')"
                                    :variant="todo.allFilter === 'all' ? 'solid' : 'outline'"
                                    color="primary"
                                    size="xs"
                                >
                                    All
                                </Button>
                                <Button
                                    @click="todo.setAllFilter('active')"
                                    :variant="todo.allFilter === 'active' ? 'solid' : 'outline'"
                                    color="primary"
                                    size="xs"
                                >
                                    Active
                                </Button>
                                <Button
                                    @click="todo.setAllFilter('completed')"
                                    :variant="todo.allFilter === 'completed' ? 'solid' : 'outline'"
                                    color="primary"
                                    size="xs"
                                >
                                    Completed
                                </Button>
                            </Row>

                            <!-- User Count (Right) -->
                            <div class="user-count-badge">
                                <Text
                                    ><Text
                                        as="span"
                                        x-text="todo.uniqueUserCount"
                                    /> contributor<Text
                                        as="span"
                                        x-show="todo.uniqueUserCount !== 1"
                                        >s</Text
                                    > online</Text
                                >
                            </div>
                        </Row>

                        <!-- Error Message -->
                        <Error x-show="todo.error" x-text="todo.error" />

                        <!-- Loading State -->
                        <Loading
                            x-show="todo.loading && todo.filteredAllTodos.length === 0"
                        >
                            Loading all todos...
                        </Loading>

                        <!-- All Todos List - Flex 1 to take remaining space -->
                        <List
                            spacing="default"
                            x-for="item in todo.filteredAllTodos"
                            x-key="item.id"
                        >
                            <ListItem align="center">
                                <Checkbox
                                    slot="left"
                                    :checked="item.is_complete"
                                    style="pointer-events: none;"
                                />
                                <Text
                                    :state="item.is_complete ? 'completed' : 'active'"
                                    x-text="item.task"
                                />
                                <Row
                                    slot="right"
                                    gap="tight"
                                    class="user-info-badge"
                                >
                                    <Text
                                        as="small"
                                        x-text="item.user_id.slice(0, 8) + '...'"
                                    />
                                    <Badge
                                        x-show="item.user_id === auth.currentUser?.id"
                                        size="xs"
                                        color="primary">You</Badge
                                    >
                                </Row>
                            </ListItem>
                        </List>

                        <!-- Empty State -->
                        <Empty
                            x-show="todo.filteredAllTodos.length === 0 && !todo.loading"
                        >
                            <Text as="p" x-show="todo.allFilter === 'all'"
                                >No todos in database.</Text
                            >
                            <Text as="p" x-show="todo.allFilter === 'active'"
                                >No active todos.</Text
                            >
                            <Text as="p" x-show="todo.allFilter === 'completed'"
                                >No completed todos.</Text
                            >
                        </Empty>
                    </Column>

                    <!-- Stats -->
                    <div
                        slot="footer"
                        x-show="todo.allTodos.length > 0"
                        class="centered-stats"
                    >
                        <Text as="span" x-text="todo.allActiveCount" /> active,
                        <Text as="span" x-text="todo.allCompletedCount" /> completed
                    </div>
                </Card>
            </Row>
        </Switch>
    </Page>
</Layout>
