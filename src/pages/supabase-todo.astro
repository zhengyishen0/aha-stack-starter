---
import Layout from "../layouts/Layout.astro";
import { Button, Card, List, Row, ListItem, Text, Space } from '../components/ui/core';
import { Checkbox, TextInput } from '../components/ui/forms';
import { Navbar } from '../components/ui/navigation';
import { Loading, Error, Empty } from '../components/ui/feedback';

// Page-specific styles
import '../styles/pages/todo.css';

const title = "Todo App with Supabase";
---

<Layout title={title}>
    <div 
        class="todo-app-container" 
        x-data="{ 
            auth: $store.auth,
            todo: $store.todo,
            async init() {
                await this.auth.init()
                await this.todo.loadTodos()
            },
            async signInAnonymously() {
                await this.auth.signInAnonymously()
                await this.todo.loadTodos()
            },
            async signOut() {
                await this.auth.signOut()
                this.todo.cleanup()
            }
        }" 
        x-init="init()"
    >
        <!-- Navigation Bar -->
        <Navbar variant="elevated" maxWidth="container">
            <Button slot="start" href="../" variant="solid" color="neutral" size="sm">Back to Home</Button>
            
            <Text slot="center" as="h1" class="navbar-title">Supabase Todo App</Text>
            
            <Space slot="end" />
        </Navbar>

        <!-- Main Content -->
        <div class="todo-main todo-main-container">
            
                <!-- Auth Status for Non-authenticated Users -->
                <Card context="spacious" x-show="!auth.isAuthenticated" class="auth-prompt">
                            <Text as="p" class="auth-prompt-text">Click to start using the app</Text>
                            <Button 
                                @click="signInAnonymously()"
                                :disabled="auth.loading || todo.loading"
                                context="nav"
                                x-text="auth.loading ? 'Signing in...' : 'Sign In Anonymously'"
                            >
                            </Button>
                </Card>

                <!-- Todo App - Two Column Layout -->
                <Row x-show="auth.isAuthenticated" class="todo-columns">
                    
                    <!-- Left Column: My Todos -->
                    <Card class="todo-column todo-column-user">
                        <Text as="h2" slot="header" class="todo-column-title">My Todos</Text>
                        <div slot="body" class="todo-column-content">

                            <!-- Filter Buttons and Auth Info -->
                            <Row justify="between" wrap>
                                <!-- Status Filter Buttons (Left) -->
                                <Row gap="tight">
                                    <Button 
                                        @click="todo.setUserFilter('all')"
                                        :class="todo.userFilter === 'all' ? 'button-solid-neutral' : 'button-soft-neutral'"
                                        context="xs"
                                    >
                                        All
                                    </Button>
                                    <Button 
                                        @click="todo.setUserFilter('active')"
                                        :class="todo.userFilter === 'active' ? 'button-solid-neutral' : 'button-soft-neutral'"
                                        context="xs"
                                    >
                                        Active
                                    </Button>
                                    <Button 
                                        @click="todo.setUserFilter('completed')"
                                        :class="todo.userFilter === 'completed' ? 'button-solid-neutral' : 'button-soft-neutral'"
                                        context="xs"
                                    >
                                        Completed
                                    </Button>
                                </Row>
                                
                                <!-- Auth Info (Right) -->
                                <Row gap="loose">
                                    <Text>Signed in as: <strong x-text="auth.userDisplayId" class="auth-user-id"></strong></Text>
                                    <Button @click="signOut()" context="xs" class="button-solid-neutral">Sign Out</Button>
                                </Row>
                            </Row>

                            <!-- Error Message -->
                            <Error x-show="todo.error" x-text="todo.error" />

                            <!-- Loading State -->
                            <Loading x-show="todo.loading && todo.filteredUserTodos.length === 0">
                                Loading your todos...
                            </Loading>

                            <!-- User Todo List - Flex 1 to take remaining space -->
                            <List 
                                spacing="default"
                                x-for="item in todo.filteredUserTodos" 
                                x-key="item.id"
                            >
                                <ListItem align="center">
                                    <Checkbox 
                                        slot="start"
                                        :checked="item.is_complete"
                                        @change="todo.toggleTodo(item.id, $event.target.checked)"
                                    />
                                    <Text 
                                        :state="item.is_complete ? 'completed' : 'active'"
                                        x-text="item.task"
                                    ></Text>
                                    <Button 
                                        slot="end"
                                        @click="todo.deleteTodo(item.id)"
                                        context="xs"
                                        class="button-solid-neutral"
                                    >
                                        Delete
                                    </Button>
                                </ListItem>
                            </List>
                            
                            <!-- Empty State -->
                            <Empty x-show="todo.filteredUserTodos.length === 0 && !todo.loading">
                                <Text as="p" x-show="todo.userFilter === 'all'">No todos yet. Add one below!</Text>
                                <Text as="p" x-show="todo.userFilter === 'active'">No active todos.</Text>
                                <Text as="p" x-show="todo.userFilter === 'completed'">No completed todos.</Text>
                            </Empty>

                        </div>
                        
                            <!-- Stats -->
                            <div slot="footer" x-show="todo.userTodos.length > 0" class="stats">
                                <Text as="span" x-text="todo.userActiveCount"></Text> active, 
                                <Text as="span" x-text="todo.userCompletedCount"></Text> completed
                            </div>
                            
                            <!-- Add Todo Form -->
                            <form slot="footer" @submit.prevent="todo.addTodo($refs.todoInput.value); $refs.todoInput.value = ''" class="todo-form">
                                <Row gap="default">
                                    <TextInput
                                        x-ref="todoInput"
                                        type="text" 
                                        placeholder="Add a new todo..."
                                        required
                                        class="todo-input-field"
                                    />
                                    <Button 
                                        type="submit"
                                        :disabled="todo.loading"
                                        context="nav"
                                        x-text="todo.loading ? '...' : 'Add'"
                                    >
                                    </Button>
                                </Row>
                            </form>
                    </Card>

                    <!-- Right Column: All Todos -->
                    <Card class="todo-column todo-column-all">
                        <Text as="h2" slot="header" class="todo-column-title">Realtime Todos</Text>
                        <div slot="body" class="todo-column-content">
                        
                            <!-- Filter Buttons and User Count -->
                            <Row justify="between" wrap>
                                <!-- Status Filter Buttons (Left) -->
                                <Row gap="tight">
                                    <Button 
                                        @click="todo.setAllFilter('all')"
                                        :class="todo.allFilter === 'all' ? 'button-solid-neutral' : 'button-soft-neutral'"
                                        context="xs"
                                    >
                                        All
                                    </Button>
                                    <Button 
                                        @click="todo.setAllFilter('active')"
                                        :class="todo.allFilter === 'active' ? 'button-solid-neutral' : 'button-soft-neutral'"
                                        context="xs"
                                    >
                                        Active
                                    </Button>
                                    <Button 
                                        @click="todo.setAllFilter('completed')"
                                        :class="todo.allFilter === 'completed' ? 'button-solid-neutral' : 'button-soft-neutral'"
                                        context="xs"
                                    >
                                        Completed
                                    </Button>
                                </Row>
                                
                                <!-- User Count (Right) -->
                                <div class="user-count">
                                    <Text><Text as="span" x-text="todo.uniqueUserCount"></Text> contributor<Text as="span" x-show="todo.uniqueUserCount !== 1">s</Text> online</Text>
                                </div>
                            </Row>

                            <!-- Error Message -->
                            <Error x-show="todo.error" x-text="todo.error" />

                            <!-- Loading State -->
                            <Loading x-show="todo.loading && todo.filteredAllTodos.length === 0">
                                Loading all todos...
                            </Loading>

                            <!-- All Todos List - Flex 1 to take remaining space -->
                            <List 
                                spacing="default"
                                x-for="item in todo.filteredAllTodos" 
                                x-key="item.id"
                            >
                                <ListItem align="center">
                                    <Checkbox 
                                        slot="start"
                                        :checked="item.is_complete"
                                        disabled
                                    />
                                    <Text 
                                        :state="item.is_complete ? 'completed' : 'active'"
                                        x-text="item.task"
                                    ></Text>
                                    <Row slot="end" gap="tight" class="todo-user-info">
                                        <Text as="small" x-text="item.user_id.slice(0, 8) + '...'"></Text>
                                        <span x-show="item.user_id === auth.currentUser?.id" class="badge badge-sm badge-blue">You</span>
                                    </Row>
                                </ListItem>
                            </List>
                            
                            <!-- Empty State -->
                            <Empty x-show="todo.filteredAllTodos.length === 0 && !todo.loading">
                                <Text as="p" x-show="todo.allFilter === 'all'">No todos in database.</Text>
                                <Text as="p" x-show="todo.allFilter === 'active'">No active todos.</Text>
                                <Text as="p" x-show="todo.allFilter === 'completed'">No completed todos.</Text>
                            </Empty>
                        </div>
                        
                            <!-- Stats -->
                            <div slot="footer" x-show="todo.allTodos.length > 0" class="stats">
                                <Text as="span" x-text="todo.allActiveCount"></Text> active, 
                                <Text as="span" x-text="todo.allCompletedCount"></Text> completed
                            </div>
                    </Card>
                </Row>
        </div>
    </div>

</Layout>